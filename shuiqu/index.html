<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>首页</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="./css/sm.min.css">
    <link rel="stylesheet" href="./css/sm-extend.min.css">
    <link rel="stylesheet" href="./css/index.css">
    
  </head>
  <body>
    <div class="page-group">
        <div class="page page-finish page-current">
            <header class="bar bar-nav top-nav">
                <span>宝安大道&gt;</span>
                <div class="searchbar">
                    <div class="search-input">
                      <label class="icon icon-111icosearch" for="search"></label>
                      <input type="search" id='search' placeholder='输入商家电话或品牌'/>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Slider -->
                <div class="swiper-container" data-space-between='0'>
                    <div class="swiper-wrapper">
                        <div class="swiper-slide"><img src="css/images/lunbo1.jpg" alt=""></div>
                        <div class="swiper-slide"><img src="css/images/lunbo1.jpg" alt=""></div>
                        <div class="swiper-slide"><img src="css/images/lunbo1.jpg" alt=""></div>
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
                <div class="notice-box">
                    <span class="icon icon-65notice"></span>
                    上线城市<em>8</em>个 企业<em>18</em>家 水店<em>25</em>间
                </div>
                <div class="home-wrap infinite-scroll">
                    <ul class="fresh">
                        <li><a href="">
                            <table>
                                <tr>
                                    <td><img src="css/images/gift.jpg" alt=""></td>
                                    <td>
                                        <h4>开户有礼</h4>
                                        <p class="red">新用户专享权利</p>
                                    </td>
                                </tr>
                            </table></a>
                        </li>
                        <li><a href="#">
                            <table>
                                <tr>
                                    <td><img src="css/images/vip.jpg" alt=""></td>
                                    <td>
                                        <h4>普通会员</h4>
                                        <p>积分：1000</p>
                                    </td>
                                </tr>
                            </table></a>
                        </li>
                    </ul>
                    <ul class="company">
                        <li><a href="">
                            <table>
                                <tr>
                                    <td><img src="css/images/dts.jpg" alt=""></td>
                                    <td>
                                        <h4>洞庭山</h4>
                                        <p>好水养人</p>
                                    </td>
                                </tr>
                            </table></a>
                        </li>
                        <li><a href="">
                            <table>
                                <tr>
                                    <td><img src="css/images/jt.jpg" alt=""></td>
                                    <td>
                                        <h4>景田</h4>
                                        <p>水中贵族 景田百岁山</p>
                                    </td>
                                </tr>
                            </table></a>
                        </li>
                        <li><a href="">
                            <table>
                                <tr>
                                    <td><img src="css/images/lbs.jpg" alt=""></td>
                                    <td>
                                        <h4>乐百氏</h4>
                                        <p>健康生活从“乐百氏”开始</p>
                                    </td>
                                </tr>
                            </table></a>
                        </li>
                    </ul>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- nav bar -->
            <nav class="bar bar-tab">
              <a class="tab-item external active" href="#">
                <svg class="icon icon-svg def" aria-hidden="true">
                    <use xlink:href="#icon-btn_home_"></use>
                </svg>
                <svg class="icon icon-svg cur" aria-hidden="true">
                    <use xlink:href="#icon-btn_home"></use>
                </svg>
                <span class="tab-label">首页</span>
              </a>
              <a class="tab-item external" href="#">
                <svg class="icon icon-svg def" aria-hidden="true">
                    <use xlink:href="#icon-btn_fx_"></use>
                </svg>
                <svg class="icon icon-svg cur" aria-hidden="true">
                    <use xlink:href="#icon-btn_fx"></use>
                </svg>
                <span class="tab-label">趣发现</span>
                <span class="badge">2</span>
              </a>
              <a class="tab-item external" href="#">
                <svg class="icon icon-svg def" aria-hidden="true">
                    <use xlink:href="#icon-btn_sd_"></use>
                </svg>
                <svg class="icon icon-svg cur" aria-hidden="true">
                    <use xlink:href="#icon-btn_sd"></use>
                </svg>
                <span class="tab-label">闪订</span>
              </a>
              <a class="tab-item external" href="#">
                <svg class="icon icon-svg def" aria-hidden="true">
                    <use xlink:href="#icon-btn_shop"></use>
                </svg>
                <svg class="icon icon-svg cur" aria-hidden="true">
                    <use xlink:href="#icon-btn_shop_"></use>
                </svg>
                <span class="tab-label">已选购</span>
              </a>
              <a class="tab-item external" href="#">
                <svg class="icon icon-svg def" aria-hidden="true">
                    <use xlink:href="#icon-btn_my_"></use>
                </svg>
                <svg class="icon icon-svg cur" aria-hidden="true">
                    <use xlink:href="#icon-btn_my"></use>
                </svg>
                <span class="tab-label">我的</span>
              </a>
            </nav>
        </div>
       
    </div>
    <script id="tpl" type="text/x-handlebars-template">
        {{#each data}}
        <li><a href="">
            <table>
                <tr>
                    <td><img src="{{img}}" alt=""></td>
                    <td>
                        <h4>{{title}}</h4>
                        <p>{{content}}</p>
                    </td>
                </tr>
            </table></a>
        </li>
        {{/each}}
    </script>
    <script type='text/javascript' src='js/common/zepto.min.js' charset='utf-8'></script>
    <script>
        $.config = {router: false}
    </script>
    <script type='text/javascript' src='js/common/sm.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='js/common/sm-extend.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='js/common/handlebars-v4.0.5.js'></script>
    <script src="./css/iconfont.js"></script>
    <script>
    //注册is操作符
    var isHelper = function() {
        var args = arguments
        ,   left = args[0]
        ,   operator = args[1]
        ,   right = args[2]
        ,   options = args[3]
        ;

        if (args.length == 2) {
            options = args[1];
            if (left) return options.fn(this);
            return options.inverse(this);
        }

        if (args.length == 3) {
            right = args[1];
            options = args[2];
            if (left == right) return options.fn(this);
            return options.inverse(this);
        }

        if (eR.call(operator, left, right)) {
            return options.fn(this);
        }
        return options.inverse(this);
    };

    Handlebars.registerHelper('is', isHelper);
    var responseMsg = {
        '-3' : 'APP未登录',
        '-2' : '微信超时',
        '-1' : '微信未登录',
        '0' : '查询数据不存在',
        '2' : '数据库执行错误',
        '3' : '参数错误',
        '4' : '接口调用错误',
        '5' : '接口调用返回结果错误'
    }
    //注册is操作符 end
    var pageSize = 3;
    var loading = false;
    var pageNo = 1;
    var canload = false;
    var getData = function(method) {
        var classId = $('.switch-wrap').attr('data-active-class');
        var tagId = $('.tabs').attr('data-active-tag');

        $.ajax({
            type: "post",
            url: "mock/company.json",
            data: {
                pageIndex: pageNo,
                pageSize: pageSize
            },
            dataType: 'json',
            complete: function(json) {
                // 重置加载flag
                loading = false;
                var data = json.response;
                    
                
                if ($.type(data) == 'string') {
                    data = JSON.parse(json.response);
                }
                if(responseMsg[data.code]){
                    $.alert(responseMsg[data.code]);
                    return;
                }
                if (data.data.length == 0) {
                    $('[data-role="null-data"]').html('没有更多内容了，请稍后刷新');
                    // 加载完毕，则注销无限加载事件，以防不必要的加载:$.detachInfiniteScroll($('.infinite-scroll').eq(tabIndex));多个无线滚动请自行根据自己代码逻辑判断注销时机
                    $.detachInfiniteScroll();
                    canload = false;
                    // 删除加载提示符
                    $('.infinite-scroll-preloader').hide();
                    return;
                } else {
                    canload = true;
                    if(data.data.length >= pageSize){
                       $('.infinite-scroll-preloader').show(); 
                    }else{
                        $('.infinite-scroll-preloader').hide();
                    }
                    var tpl = $("#tpl").html();
                   
                    var template = Handlebars.compile(tpl);
                    var context = {
                        data: data.data
                    };
                    var html = template(context);
                    if(method == 'pull'){
                        $('.company').append(html);
                    }else{
                        $('.company').html(html);
                    }
                    
                }

                $.refreshScroller();
            }
        });
    };

    $(document).on("pageInit", function(e, id, page) {

        

        $(page).on('infinite', function() {

            // 如果正在加载，则退出
            if (loading) return;

            // 设置flag
            loading = true;
            
            //新增一页
            pageNo = pageNo + 1;
      
            getData('pull');
            
        });
    });
        $.init();
        $(function() {
           getData();
        });
    </script>
  </body>
</html>