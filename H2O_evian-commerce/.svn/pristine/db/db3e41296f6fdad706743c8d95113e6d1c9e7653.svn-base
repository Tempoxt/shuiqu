<!DOCTYPE html>
<html lang="en">
#parse("control/$!webStyle/version.vm")
#parse("control/$!webStyle/indexCss.vm")
<body>
    <div class="page-group">
        <div class="page page-finish page-current product-detail">
            <header class="bar bar-nav light-nav" data-role="header">
                
            </header>

            <div class="content pb3">
                <!-- Slider -->
                <div id="swiper-container" data-space-between='0' style="height: 46%">
                    <div class="swiper-wrapper" data-role="swiper-wrap">
                        
                    </div>
                    <div class="swiper-pagination"></div>
                </div>
                <div class="product-info model-box" data-role="product-info" style="margin-bottom: 0.5rem;">
                    
                </div>
                <table class="show-pro-info" data-role="show-info">
                    
                </table>
                <div class="model-box recommend-wrap" data-role="recommend-wrap">
                    
                </div>
                <div class="model-box store-info-wrap" data-role="store-wrap"> 
                    
                </div>
                <div class="go-ahead ">
                    <a class1="open-evaluate" href="#" id="showProductEvaluate">查看商品评价<span class="icon icon-ico_awwor_right"></span></a>
                </div>
                <div class="go-ahead ">
                    <a class="open-detail">查看商品详情<span class="icon icon-ico_awwor_right"></span></a>
                </div>

            </div>
            <div class="bar bar-footer order-bar">
                <table>
                    <tr>
                        <td>
                            <svg class="icon-svg car" aria-hidden="true">
                                <a href="/weixin/shoppingCar" id="goBuy">
                                    <use xlink:href="#icon-shopping_ico_cart"></use>
                                </a>
                            </svg>
                            <a href="/weixin/shoppingCar" class="badge" id="badgeNum">0</a>
                        </td>
                        <td class="go-buy">
                            
                            <p><a href="/weixin/shoppingCar" class="button button-fill btn-yello"  data-role="go-buy" >立即购买</a></p>
                        </td>
                        <td class="add-shopCart">
                            <p><a href="#" data-action="add-shopCart" id="add-shopCart" class="button button-fill btn-yello" data-pid="">加入购物车</a></p>
                        </td>
                    </tr>
                </table>
            </div>

            
        </div>
        <!-- 评价浮层 -->
        <!-- <div class="popup popup-evaluate" data-role="evaluate">
          <div class="content-block">
            <header class="bar bar-nav  light-nav">
                <span class="icon icon-35icoback pull-left close-popup bar-left"></span>
                <h1 class="title">商品评价</h1>
            </header>
            <div class="content infinite-scroll infinite-scroll-bottom" data-role="evaluate-content"  data-distance="50">
                <div class="choose-evaluate">
                    <p class="evaluate-tab" data-role="evaluate-tab">
                        
                    </p>
                    <label class="label-checkbox item-content">
                        <input type="checkbox" value="1" name="cart-child" />
                        <div class="item-media"><i class="icon icon-form-checkbox"></i>只显示有图片的内容</div>
                    </label>
                </div>
                <ul class="evaluate-list tab  active" data-role="evaluate-list">
                    
                </ul>
                
            </div>
          </div>
        </div> -->
        <!-- 详情浮层 -->
        <div class="popup popup-productDetail">
          <div class="content-block" data-role="imgText">
            
          </div>
        </div>
    </div>

<script id="imgTextTpl" type="text/x-handlebars-template">
    <header class="bar bar-nav  light-nav">
        <span class="icon icon-35icoback pull-left close-popup bar-left"></span>
        <h1 class="title">{{data.product.pname}}</h1>
    </header>
    <div class="content">
        
    </div>
</script>
<script id="headerTpl" type="text/x-handlebars-template">
    <a href="javascript:history.go(-1);" class="icon icon-35icoback pull-left go-back bar-left"></a>  
    <h1 class="title">商品详情</h1>
    {{#is data.product.property "水"}}
    <a href="" data-action="add-habit">
        <svg class="icon icon-svg title-icon pull-right" aria-hidden="true">
            <use xlink:href="#icon-btn_sp_habit"></use>
        </svg>
    </a>
    {{/is}}
</script>
<script id="swipeTpl" type="text/x-handlebars-template">
    {{#each data.photos}}
        <a class="swiper-slide" href="#"><img src="{{this}}"></div>
    {{/each}}
</script>
<!-- <script id="tabTpl" type="text/x-handlebars-template">
    <a data-grade="-1" class="active" href="#">全部{{data.count}}</a>
    <a data-grade="1" href="#">好评{{data.goodCount}}</a>
    <a data-grade="2" href="#">中评{{data.centerCount}}</a>
    <a data-grade="3" href="#">差评{{data.badCount}}</a>
</script> -->
<!-- <script id="evaluateTpl" type="text/x-handlebars-template">
    {{#each data.evaluates}}
        <li>
            <table>
                <tr>
                    <td>
                        {{#unless photo}}
                        <img src="http://7xlmry.com1.z0.glb.clouddn.com/noimg200.jpg" alt="">
                        {{else}}
                        <img src="{{photo}}" alt="">
                        {{/unless}}
                    </td>
                    <td>
                        <h5>{{account}}<span class="time">{{createDate}}</span></h5>
                        <div class="stars" data-grade="{{grade}}">
                            {{{showstars grade}}}
                        </div>
                        <p>
                            {{evaluateStr}}
                        </p>
                    </td>

                </tr>
            </table>
        </li>
    {{/each}}
</script> -->
<script id="productTpl" type="text/x-handlebars-template">
        <!-- <h4 class="model-tit">商品信息</h4> -->
        <h5 class="pro-tit">{{data.product.pname}} <!-- <a class="icon icon-76share"></a> --></h5>
        {{#is data.product.pledgeRemark}}<a href="/weixin/productDetail?pid={{data.product.pledgePid}}&shopId={{data.shop.shopId}}" class="pledgeRemark">{{data.product.pledgeRemark}}</a>{{/is}}
        <div class="info-detail">
            <div class="price-box" id="price-box">
                <span class="vip-price">￥{{data.product.vipPrice}}</span>
                价格:<span class="price">{{data.product.price}}</span>
                {{#is data.product.ifTicket true}}<span class="ticket">可以票结算</span>{{/is}}
                <input type="hidden" name="num" value="0" data-pid="">
                <!-- <a href="#" data-action="add-shopCart" class="button button-fill btn-yello" id="add-cart1" data-pid="">加入购物车</a>
                <p class="car-count" data-action="add-cart" id="add-cart2" data-pid="">
                    <em data-action="minus" data-pid="">
                        <svg class="icon-svg" aria-hidden="true">
                            <use xlink:href="#icon-shopping_btn_num_minus"></use>
                        </svg>
                    </em>
                    
                    <input type="hidden" name="num" data-sum="0" value="0" data-pid=""><i data-pid="">0</i>
                    
                    
                    <em data-action="add" data-pid="">
                        <svg class="icon-svg" aria-hidden="true">
                           <use xlink:href="#icon-shopping_btn_num_add"></use>
                        </svg> 
                    </em>
                </p> -->
            </div>
            <ul>
                {{#is data.product.weight}}<li>规格<span>&nbsp;&nbsp;{{data.product.weight}}</span></li>{{/is}}
                <li>运费<span>&nbsp;&nbsp;{{#is data.product.freight}}{{data.product.freight}}{{else}}免运费{{/is}}</span>{{#is data.product.sendArea}}&nbsp;&nbsp;配送范围<span>&nbsp;&nbsp;{{data.product.sendArea}}</span>{{/is}}</li>
            </ul>
            <!-- <table> -->
                <!-- <tr>
                    <th>品牌</th>
                    <td>{{data.product.brandName}}</td>
                </tr> -->
                <!-- <tr>
                    <th>单位</th>
                    <td>{{data.product.unit}}</td>
                </tr> -->
                <!-- <tr>
                    <th>规格</th>
                    <td>{{data.product.weight}}</td>
                </tr>
                <tr>
                    <th>运费</th>
                    <td>{{data.product.freight}}</td>
                    <td>配送范围</td>
                    <td>{{data.product.sendArea}}</td>
                </tr> -->
                <!-- <tr>
                    <th>结算方式</th>
                    <td>
                        <label class="label-checkbox item-content">
                            <input disabled="disabled" type="checkbox" {{#is data.product.ifTicket true}} checked="checked" {{/is}} name="" />
                            <div class="item-media"><i class="icon icon-form-checkbox"></i></div>
                        </label>可票结算
                    </td>
                </tr> -->
            <!-- </table> -->
        </div>
</script>
<script id="showinfoTpl" type="text/x-handlebars-template">
    <tr>
        <!-- <td>{{#is data.shop.freight '>' 0}}配送费{{data.shop.freight}}元{{else}}免运费{{/is}}</td>
        <td>已销售：<span>{{data.product.salesNum}}</span></td> -->
    </tr>
</script>
<script id="recommendTpl" type="text/x-handlebars-template">
    <h4 class="model-tit">相关优惠</h4>
    <ul class="suggest-list">
        {{#each data.taocans}}
        <li>
            <a href="/weixin/productDetail?pid={{pid}}&shopId={{../shopId}}">
                <table>
                    <tr>
                        <td>
                            <img src="{{pictureUrl}}" alt="">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <p>{{pname}}</p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span>
                                ￥{{vipPrice}}
                            </span>
                        </td>
                    </tr>
                </table>
            </a>
        </li>
        {{/each}}
    </ul>
</script>
<script id="storeTpl" type="text/x-handlebars-template">
        <!-- <h4 class="model-tit">店铺信息</h4> -->
        <table class="store-tit-box">   
            <tr>    
                <td><img src="{{data.shop.pictureUrl}}" alt=""></td>
                <td>    
                    <h4>{{data.shop.shopName}}</h4>
                    <div data-grade="{{data.shop.grade}}">
                        {{{showstars data.shop.grade}}}
                    </div>
                </td>
                <td>
                    <a href="/weixin/products?shopId={{data.shop.shopId}}">进店逛逛</a>
                </td>
            </tr>
        </table>
        <table class="store-info-list">
            <tr>
                <td>
                    <p><span>{{data.shop.sendOnTime}}</span><em>分钟</em></p>
                    <p>平均送达时间</p>
                </td>
                <td>
                    <p>
                        <em>￥</em><span>{{data.shop.minSendPrice}}</span>
                    </p>
                    <p>起送价</p>
                </td>
                <td>
                    <p><em>￥</em><span>{{data.shop.freight}}</span></p>
                    <p>配送费</p>
                </td>
            </tr>
        </table>
</script>
    #*加载JS文件*# 
    #parse("control/$!webStyle/publicJs.vm")
    #parse("control/$!webStyle/globalJs.vm")
    <script>
        $(function() {
            //获取url中的shopId和pid
            var shopId = Number(getQueryString('shopId'));
            var pid = Number(getQueryString('pid'));
            
            //查看商品评价
            $("#showProductEvaluate").on('click',function(e){
                e.preventDefault();
                window.location.href="/weixin/productEvaluate?pid="+pid;
            });
            
            //获取商品详情
            $.ajax({
                type: "get", 
                url: "/weixin/getProductDetail",
                data: {
                    shopId: shopId,
                    pid: pid
                },
                dataType: 'json',
                async:false,
                complete: function(json) {
                  
                    var data = json.response;
                    var status = json.status;
                    if(status != 200){
                        $.alert('网络异常，状态为18.1' + status);
                        return;
                    }
                    if ($.type(data) == 'string') {
                        data = JSON.parse(data);
                    }
                    if(data.code != 'E00000'){
                        if(data.code == "-1"){
                            window.location.href = "/weixin/bind";
                        }else{
                            $.alert(data.message);
                            return;
                        }
                    }else{
                        var context = {
                            data: data.data,
                            shopId: shopId
                        };
                        if(data.data.photos.length){
                            var swipeTpl = $("#swipeTpl").html();
                            var swipeTemplate = Handlebars.compile(swipeTpl);
                            var swipeCont = swipeTemplate(context);
                            $('[data-role="swiper-wrap"]').html(swipeCont);

                             // $("#swiper-container").swiper({
                             //    autoplay: 2000,
                             //    pagination: '.swiper-pagination'
                             //    //spaceBetween: 15
                             //  })
                             $("#swiper-container").swiper({
                                autoplay: 2000,
                                autoplayDisableOnInteraction: false,
                                pagination: '.swiper-pagination'
                            });
                            $.reinitSwiper('#swiper-container');
                            // $.reinitSwiper(0);
                        }
                        var productTpl = $("#productTpl").html();
                        var productTemplate = Handlebars.compile(productTpl);
                        var productCont = productTemplate(context);
                        $('[data-role="product-info"]').html(productCont);

                        var headerTpl = $("#headerTpl").html();
                        var headerTemplate = Handlebars.compile(headerTpl);
                        var headerCont = headerTemplate(context);
                        $('[data-role="header"]').html(headerCont);
                        //返回到上级页面
                        // $('.go-back').attr('href', '/weixin/products?shopId=' + shopId);

                        $('[name="num"]').attr('data-pid',pid);
                        $('#add-cart').attr('data-pid',pid);
                        // $('#add-cart2').attr('data-pid',pid);
                        // $('#add-cart2').find('em,input,i').attr('data-pid',pid);
                        $.ajax({
                            type: "get",
                            url: "/weixin/getShopCartProductJson",
                            dataType: 'json',
                            complete: function(json) {
                            
                                var data = json.response;
                                var status = json.status;
                                if(status != 200){
                                    $.alert('网络异常，状态为3.2' + status);
                                    return;
                                }
                                if ($.type(data) == 'string') {
                                    data = JSON.parse(data);
                                }
                                if(data.code != 'E00000'){
                                    if(data.code == "-1"){
                                        window.location.href = "/weixin/bind";
                                    }else{
                                        $.alert(data.message);
                                        return;
                                    }
                                  
                                }else{
                                    // if(data.data.shopcarts.length==0){

                                    //     $('[data-role="go-buy"]').addClass('gray-color');
                                    //     $('[data-role="go-buy"]').bind('click',function(e){
                                    //         e.preventDefault();
                                    //     });
                                    //     $("#add-cart1").show();
                                    //     $("#add-cart2").hide();
                                    // }else{
                                    //     $('[data-role="go-buy"]').removeClass('gray-color');
                                    //     $('[data-role="go-buy"]').unbind('click');
                                    //     $("#add-cart1").hide();
                                    //     $("#add-cart2").show();
                                    // }

                                    var productNumber = 0;
                                    //购物车商品数量大于等于1
                                    if(data.data.shopcarts.length>=1){
                                        for(var i=0,len=data.data.shopcarts.length;i<len;i++){
                                            //购物车中有该水店的产品
                                            if(data.data.shopcarts[i].shopId==shopId){
                                                // debugger;
                                                for(var j=0;j<data.data.shopcarts[i].products.length;j++){
                                                    //购物车商品总数
                                                    productNumber += data.data.shopcarts[i].products[j].number;
                                                    console.log(productNumber);
                                                    //
                                                    if($('[name="num"]').data('pid')==data.data.shopcarts[i].products[j].pid){
                                                        //购物车中有水店下的该产品
                                                        $('[name="num"]').val(data.data.shopcarts[i].products[j].number);
                                                        // console.log(data.data.shopcarts[i].products[j].number);
                                                    }
                                                    // for(var k=0;k<$('.car-count').length;k++){
                                                    //     // console.log(k);
                                                    //     //购物车中有水店下的该产品
                                                    //     if($('.car-count').eq(k).data('pid')==data.data.shopcarts[i].products[j].pid){
                                                    //         $('.car-count').eq(k).find('input[type="hidden"]').val(data.data.shopcarts[i].products[j].number);
                                                    //         $('.car-count').eq(k).find('i').show().html(data.data.shopcarts[i].products[j].number);
                                                    //         // $('.car-count').eq(k).find('[data-action="minus"]').show();
                                                    //         // $("#add-cart1").hide();
                                                    //         // $("#add-cart2").show();
                                                    //     }
                                                    //     //购物车中没有水店下的该产品
                                                    //     // }else{
                                                    //     //     $("#add-cart1").show();
                                                    //     //     $("#add-cart2").hide();
                                                    //     // }
                                                    // }
                                                    
                                                }
                                            //购物车中没有该水店的产品
                                            }else{
                                                // debugger;
                                                for(var j=0;j<data.data.shopcarts[i].products.length;j++){
                                                    productNumber += data.data.shopcarts[i].products[j].number;
                                                }
                                                // $("#add-cart1").show();
                                                // $("#add-cart2").hide();
                                                
                                            }

                                        }
                                        $('[data-role="go-buy"]').removeClass('gray-color');
                                        // $('[data-role="go-buy"]').unbind('click');
                                        $('#goBuy').unbind('click');
                                        $('#badgeNum').unbind('click');
                                    //购物车中无商品    
                                    }else{
                                        $('[data-role="go-buy"]').addClass('gray-color');
                                        $('[data-role="go-buy"]').on('click',function(e){
                                            e.preventDefault();

                                        });
                                        $('#goBuy').on('click',function(e){
                                            e.preventDefault();
                                        });
                                        $('#badgeNum').on('click',function(e){
                                            e.preventDefault();
                                        });
                                        // $("#add-cart1").show();
                                        // $("#add-cart2").hide();
                                    }
                                    $("#badgeNum").html(productNumber);
                                    
                                }
                              
                            }
                        });



                        var showinfoTpl = $("#showinfoTpl").html();
                        var showinfoTemplate = Handlebars.compile(showinfoTpl);
                        var showinfoCont = showinfoTemplate(context);
                        $('[data-role="show-info"]').html(showinfoCont);
                        
                        if(data.data.taocans.length){
                            var recommendTpl = $("#recommendTpl").html();
                            var recommendTemplate = Handlebars.compile(recommendTpl);
                            var recommendCont = recommendTemplate(context);
                            $('[data-role="recommend-wrap"]').html(recommendCont);
                        }
                        var storeTpl = $("#storeTpl").html();
                        var storeTemplate = Handlebars.compile(storeTpl);
                        var storeCont = storeTemplate(context);
                        $('[data-role="store-wrap"]').html(storeCont);
                        // debugger;


                        var imgTextTpl = $("#imgTextTpl").html();
                        var imgTextTemplate = Handlebars.compile(imgTextTpl);
                        var imgTextCont = imgTextTemplate(context);
                        $('[data-role="imgText"]').html(imgTextCont);
                        if(data.data.product.imageTextUrl){
                            // $.alert(data.data.product.imageTextUrl);
                            $.ajax({
                                type: "get",
                                url:"http://7xlmry.com1.z0.glb.clouddn.com/Upload/files/20171207/171207134821198595.html",
                                dataType:"html",
                                success:function(result){
                                    $('[data-role="imgText"] .content').html(result);
                                }

                            })
                            /*try{
                                var ajax = new XMLHttpRequest();
                                ajax.open('get',data.data.product.imageTextUrl);
                                ajax.send();
                                ajax.onreadystatechange = function (a) {
                                   if (ajax.readyState==4 &&ajax.status==200) {
                                　　　　$.alert(ajax.responseText);//输入相应的内容
                                  　　}
                                }

                            }catch(e){
                             $.alert(1);   
                            }*/
                        }
                        // $('.open-detail').attr({'data-pname':data.data.product.pname,'data-url':data.data.product.imageTextUrl});
                        
                    }
                    
                }
            }); 
            
            //获取评价数据
            // function getEvaluateTab(pageIndex, grade){
            //     $.ajax({
            //         url: "/weixin/getProductEvaluates",
            //         data: {
            //            pid: pid, 
            //            isPic:false,
            //            pageIndex: pageIndex,
            //            grade: grade
            //         },
            //         type: "get",
            //         dataType: "json",
            //         complete: function (result) {
                        
            //             var status = result.status;
            //             if(status != 200){
            //                 $.alert('网络异常，状态为18.2' + status);
            //                 return;
            //             }
            //             var resp = result.response;
                       
            //             if ($.type(resp) == 'string') {
            //                 resp = JSON.parse(resp);
            //             }
            //             if(resp.code != 'E00000'){
            //                 $.alert(resp.message);
            //                 return;
            //             }else{
            //                 var context = {
            //                     data: resp.data
            //                 };
            //                 var tabTpl = $("#tabTpl").html();
            //                 var tabTemplate = Handlebars.compile(tabTpl);
            //                 var tabCont = tabTemplate(context);
            //                 $('[data-role="evaluate-tab"]').html(tabCont);
            //             }
            //         }
            //     });
            // }
            // getEvaluateTab(pageIndex, grade);

            // function getEvaluates(pageIndex, grade){
            //     $.ajax({
            //         url: "/weixin/getProductEvaluates",
            //         data: {
            //            pid: pid, 
            //            isPic:false,
            //            pageIndex: pageIndex,
            //            grade: grade
            //         },
            //         type: "get",
            //         dataType: "json",
            //         complete: function (result) {
                        
            //             var status = result.status;
            //             if(status != 200){
            //                 $.alert('网络异常，状态为18.2' + status);
            //                 return;
            //             }
            //             var resp = result.response;
                       
            //             if ($.type(resp) == 'string') {
            //                 resp = JSON.parse(resp);
            //             }
            //             if(resp.code != 'E00000'){
            //                 $.alert(resp.message);
            //                 return;
            //             }else{
            //                 if(resp.data.count > 0){
            //                     var context = {
            //                         data: resp.data
            //                     };
            //                     var evaluateTpl = $("#evaluateTpl").html();
            //                     var evaluateTemplate = Handlebars.compile(evaluateTpl);
            //                     var evaluateCont = evaluateTemplate(context);
            //                     $('[data-role="evaluate-list"]').html(evaluateCont);

                                
            //                 }else{
            //                     $('[data-role="evaluate-list"]').html('<div class="defaut-wrap"><h2 class="def-note">暂无商品评价哦~</h2></div>');
            //                 }
                            
            //             }
            //         }
            //     });
            // }
            //查看评价
            // $(document).on('click','.open-evaluate', function (e) {
            //     e.preventDefault();
              
            //     getEvaluates(pageIndex, grade);
            //     $.popup('.popup-evaluate');

            // });
            // $(document).on('infinite',function(){
            //     debugger;
            //     // 如果正在加载，则退出
            //     if (loading) return;

            //     // 设置flag
            //     loading = true;
                
            //     //新增一页
            //     pageIndex = pageIndex + 1;

            //     getEvaluates(pageIndex, grade);

            // });
            // alert($('[data-role="evaluate"]').html());
            // $('[data-role="evaluate"]').on('infinite', function() {
            //     // 如果正在加载，则退出
            //     if (loading) return;

            //     // 设置flag
            //     loading = true;
                
            //     //新增一页
            //     pageIndex = pageIndex + 1;

            //     getEvaluates(pageIndex, grade);

            // });
            
            // $('[data-role="evaluate-content"]').delegate('.evaluate-tab a','click',function(e){
            //     e.preventDefault();
              
            //     var me = $(this);
            //     var grade = me.data('grade');

            //     me.addClass('active');
            //     me.siblings().removeClass('active');
                
            //     getEvaluates(pageIndex, grade);

            // });
            //查看详情
            $(document).on('click','.open-detail',function(e) {
                e.preventDefault();
                $.popup('.popup-productDetail');
            });
            //加入购物车
            // $('[data-role="product-info"]').delegate("a", "click", function(e){
            //     e.preventDefault();
            //     var me = $(this),
            //         action = me.data('action');

            //         if(action == 'add-cart'){
            //             var product = [{
            //                 "shopId": shopId,
            //                 "pid": pid,
            //                 "number": 1
            //             }];

            //             $.ajax({
            //                 type: "post",
            //                 url: "/weixin/editShopCart",
            //                 data:{
            //                     products:JSON.stringify(product)
            //                 },
            //                 dataType: 'json',
            //                 complete: function(json) {
                              
            //                     var data = json.response;
            //                     var status = json.status;
            //                     if(status != 200){
            //                         $.alert('网络异常，状态为18.3' + status);
            //                         return;
            //                     }
            //                     if ($.type(data) == 'string') {
            //                         data = JSON.parse(data);
            //                     }
            //                     if(data.code != 'E00000'){
            //                         $.alert(data.message);
            //                         return;
            //                     }else{
            //                         $.ajax({
            //                             type: "get",
            //                             url: "/weixin/getShopCartProductJson",
            //                             dataType: 'json',
            //                             complete: function(json) {
                                        
            //                                 var data = json.response;
            //                                 var status = json.status;
            //                                 if(status != 200){
            //                                     $.alert('网络异常，状态为3.2' + status);
            //                                     return;
            //                                 }
            //                                 if ($.type(data) == 'string') {
            //                                     data = JSON.parse(data);
            //                                 }
            //                                 if(data.code != 'E00000'){
            //                                     $.alert(data.message, function () {
            //                                         window.location.href = "/weixin/bind";
            //                                     });
                                              
            //                                 }else{
            //                                     if(data.data.shopcarts.length==0){
            //                                         $('[data-role="go-buy"]').addClass('gray-color');
            //                                         $('[data-role="go-buy"]').bind('click',function(e){
            //                                             e.preventDefault();
            //                                         });
            //                                     }else{
            //                                         $('[data-role="go-buy"]').removeClass('gray-color');
            //                                         $('[data-role="go-buy"]').unbind('click');
            //                                         $("#add-cart1").hide();
            //                                         $("#add-cart2").show();
            //                                     }
                                                
            //                                 }
                                          
            //                             }
            //                         });
            //                     }
                                
            //                 }
            //             });
            //         }
            // });
            //购物车数量加减
            // $('[data-role="product-info"]').delegate("a,em", "click", function(e){
            //     e.preventDefault();
            //     // debugger;
            //     // debugger;
            //     var me = $(this),
            //         numbox = me.siblings('input'),
            //         show = me.siblings('i'),
            //         action = me.data('action'),
            //         numValue = 0,
            //         pid = parseInt(me.data('pid'));
            //         // console.log(eTicketMax);
            //         //新增商品
            //         if(action == 'add-shopCart'){
            //             debugger;
            //             numValue = 1;
            //             $("#add-cart1").hide();
            //             $("#add-cart2").show();
            //             $(".car-count").find('i').html(numValue);
            //             $(".car-count").find('input').val(numValue);
            //             $("#badgeNum").html(Number($("#badgeNum").html())+1);
            //             // $('[data-role="go-buy"]').removeClass('gray-color');
            //             // $('[data-role="go-buy"]').unbind('click');
            //         }else if(action == 'add'){
            //             numValue = parseInt(numbox.val()) + 1;
            //             if(numValue>0){
            //                 // $(this).siblings().show();
            //                 /*for(var i=0,len=$(".car-count").length;i<len;i++){
            //                     if($(".car-count").eq(i).data('pid')==pid){
            //                         // $(".car-count").eq(i).find('i').show();
            //                         // $(".car-count").eq(i).find('[data-action="minus"]').show();
            //                     }
                                
            //                 }*/

            //                 $("#add-cart1").hide();
            //                 $("#add-cart2").show();
            //             }
            //             $("#badgeNum").html(Number($("#badgeNum").html())+1);
            //         //删减商品                   
            //         }else if(action == 'minus'){
            //             if(numbox.val() > 1){
            //                 numValue = parseInt(numbox.val()) - 1;
            //             }else if(numbox.val() == 1){
            //                 numValue = 0;
            //                 /*for(var i=0,len=$(".car-count").length;i<len;i++){
            //                     if($(".car-count").eq(i).data('pid')==pid){
            //                         // $(".car-count").eq(i).find('i').hide();
            //                         $(".car-count").eq(i).find('[data-action="minus"]').hide();
            //                     }
                                
            //                 }*/
            //                 $("#add-cart1").show();
            //                 $("#add-cart2").hide();
                            
            //             }
            //             $("#badgeNum").html(Number($("#badgeNum").html())-1);
            //         }
                    
            //         var product = [{
            //             "shopId": shopId,
            //             "pid": pid,
            //             "number": numValue
            //         }];
            //         //商品总数大于0
            //         if(numValue>0){
            //             $.ajax({
            //                 type: "post",
            //                 url: "/weixin/editShopCart",
            //                 data:{
            //                     products:JSON.stringify(product)
            //                 },
            //                 dataType: 'json',
            //                 complete: function(json) {
                              
            //                     var data = json.response;
                                
            //                     if ($.type(data) == 'string') {
            //                         data = JSON.parse(data);
            //                     }
            //                     if(data.code != 'E00000'){
            //                         $.alert(data.message);
            //                         return;
            //                     }else{
            //                         $.ajax({
            //                             type: "get",
            //                             url: "/weixin/getShopCartProductJson",
            //                             dataType: 'json',
            //                             complete: function(json) {
                                        
            //                                 var data = json.response;
            //                                 var status = json.status;
            //                                 if(status != 200){
            //                                     $.alert('网络异常，状态为3.2' + status);
            //                                     return;
            //                                 }
            //                                 if ($.type(data) == 'string') {
            //                                     data = JSON.parse(data);
            //                                 }
            //                                 if(data.code != 'E00000'){
            //                                     if(data.code == "-1"){
            //                                         window.location.href = "/weixin/bind";
            //                                     }else{
            //                                         $.alert(data.message);
            //                                         return;
            //                                     }
                                              
            //                                 }else{
            //                                     // debugger;
            //                                     if(data.data.shopcarts.length>=1){
            //                                         $("[data-role='go-buy']").removeClass('gray-color');
            //                                         $("[data-role='go-buy']").unbind('click');
            //                                     }
            //                                 }
            //                             }
            //                         });
            //                         // $.toast("添加成功");
            //                     }
                                
            //                 }
            //             });
            //         //商品总数为0
            //         }else{
            //             $.ajax({
            //                 type: "post",
            //                 url: "/weixin/editShopCart",
            //                 data:{
            //                     tag:"DEL",
            //                     products:JSON.stringify(product)
            //                 },
            //                 dataType: 'json',
            //                 complete: function(json) {
                              
            //                     var data = json.response;
                                
            //                     if ($.type(data) == 'string') {
            //                         data = JSON.parse(data);
            //                     }
            //                     if(data.code != 'E00000'){
            //                         if(data.code == "-1"){
            //                             window.location.href = "/weixin/bind";
            //                         }else{
            //                             $.alert(data.message);
            //                             return;
            //                         }
            //                     }else{
            //                         $.ajax({
            //                             type: "get",
            //                             url: "/weixin/getShopCartProductJson",
            //                             dataType: 'json',
            //                             complete: function(json) {
                                        
            //                                 var data = json.response;
            //                                 var status = json.status;
            //                                 if(status != 200){
            //                                     $.alert('网络异常，状态为3.2' + status);
            //                                     return;
            //                                 }
            //                                 if ($.type(data) == 'string') {
            //                                     data = JSON.parse(data);
            //                                 }
            //                                 if(data.code != 'E00000'){
            //                                     if(data.code == "-1"){
            //                                         window.location.href = "/weixin/bind";
            //                                     }else{
            //                                         $.alert(data.message);
            //                                         return;
            //                                     }
                                              
            //                                 }else{
            //                                     if(data.data.shopcarts.length==0){
            //                                         $("[data-role='go-buy']").addClass('gray-color');
            //                                         $("[data-role='go-buy']").bind('click',function(e){
            //                                             e.preventDefault();
            //                                         });
            //                                     }
            //                                 }
            //                             }
            //                         });
            //                         // $.toast("删除成功");
            //                     }
                                
            //                 }
            //             });
            //         }
                    
            //         for(var i=0,len=$(".car-count").length;i<len;i++){
            //             if($(".car-count").eq(i).data('pid')==pid){
            //                 $(".car-count").eq(i).find('input').val(numValue)
            //                 $(".car-count").eq(i).find('i').html(numValue)
            //             }
                        
            //         }
                    
                    
                    
            // });

            $('[data-role="go-buy"]').click(function(){
                // alert(1);
                // $('[data-action="add-shopCart"]').trigger("click");
                var num = $('[name="num"]').val();
                num++;
                $('[name="num"]').val(num);
                $("#badgeNum").html(Number($("#badgeNum").html())+1);
                var product = [{
                    "shopId": shopId,
                    "pid": pid,
                    "number": num
                }];
                $.ajax({
                    type: "post",
                    url: "/weixin/editShopCart",
                    data:{
                        products:JSON.stringify(product)
                    },
                    dataType: 'json',
                    complete: function(json) {
                      
                        var data = json.response;
                        
                        if ($.type(data) == 'string') {
                            data = JSON.parse(data);
                        }
                        if(data.code != 'E00000'){
                            $.alert(data.message);
                            return;
                        }else{
                            $.toast('加入成功');
                            $.ajax({
                                type: "get",
                                url: "/weixin/getShopCartProductJson",
                                dataType: 'json',
                                complete: function(json) {
                                
                                    var data = json.response;
                                    var status = json.status;
                                    if(status != 200){
                                        $.alert('网络异常，状态为3.2' + status);
                                        return;
                                    }
                                    if ($.type(data) == 'string') {
                                        data = JSON.parse(data);
                                    }
                                    if(data.code != 'E00000'){
                                        if(data.code == "-1"){
                                            window.location.href = "/weixin/bind";
                                        }else{
                                            $.alert(data.message);
                                            return;
                                        }
                                      
                                    }else{
                                      
                                        if(data.data.shopcarts.length>=1){
                                            $("[data-role='go-buy']").removeClass('gray-color');
                                            $("[data-role='go-buy']").unbind('click');
                                            $('#goBuy').unbind('click');
                                            $('#badgeNum').unbind('click');
                                        }
                                    }
                                }
                            });
                           
                        }
                        
                    }
                });
                
            });

            //添加商品到购物车
            $('[data-action="add-shopCart"]').on('click',function(){
                var num = $('[name="num"]').val();
                num++;
                $('[name="num"]').val(num);
                $("#badgeNum").html(Number($("#badgeNum").html())+1);
                var product = [{
                    "shopId": shopId,
                    "pid": pid,
                    "number": num
                }];
                $.ajax({
                    type: "post",
                    url: "/weixin/editShopCart",
                    data:{
                        products:JSON.stringify(product)
                    },
                    dataType: 'json',
                    complete: function(json) {
                      
                        var data = json.response;
                        
                        if ($.type(data) == 'string') {
                            data = JSON.parse(data);
                        }
                        if(data.code != 'E00000'){
                            $.alert(data.message);
                            return;
                        }else{
                            $.toast('加入成功');
                            $.ajax({
                                type: "get",
                                url: "/weixin/getShopCartProductJson",
                                dataType: 'json',
                                complete: function(json) {
                                
                                    var data = json.response;
                                    var status = json.status;
                                    if(status != 200){
                                        $.alert('网络异常，状态为3.2' + status);
                                        return;
                                    }
                                    if ($.type(data) == 'string') {
                                        data = JSON.parse(data);
                                    }
                                    if(data.code != 'E00000'){
                                        if(data.code == "-1"){
                                            window.location.href = "/weixin/bind";
                                        }else{
                                            $.alert(data.message);
                                            return;
                                        }
                                      
                                    }else{
                                      
                                        if(data.data.shopcarts.length>=1){
                                            $("[data-role='go-buy']").removeClass('gray-color');
                                            $("[data-role='go-buy']").unbind('click');
                                            $('#goBuy').unbind('click');
                                            $('#badgeNum').unbind('click');
                                        }
                                    }
                                }
                            });
                           
                        }
                        
                    }
                });
                
            });
            //添加商品消费习惯
            $('[data-role="header"]').delegate('[data-action="add-habit"]','click',function(e){

                e.preventDefault();

                $.prompt('填写您习惯订购该商品的数量', '消费习惯',
                    function (value) {
                   
                      if($.trim(value)>0 && !isNaN(parseInt($.trim(value))) && $.trim(value) % 1==0){

                        var habit = {
                            shopId: shopId,
                            pid: pid,
                            number: value
                        };
                         $.ajax({
                            type: "get",
                            url: "/weixin/addClientHabit",
                            data: {
                                habit: JSON.stringify(habit) 
                            },
                            dataType: 'json',
                            complete: function(json) {
                              
                                var data = json.response;
                                
                                if ($.type(data) == 'string') {
                                    data = JSON.parse(data);
                                }
                                
                                if(data.code != 'E00000'){
                                    if(data.code == "-1"){
                                        window.location.href = "/weixin/bind";
                                    }else{
                                        $.alert(data.message);
                                        return;
                                    }
                                }else{
                                    $.alert('操作成功');
                                }
                                
                            }
                        });   
                      }else if(isNaN(parseInt($.trim(value))) ){
                            $.alert('请输入数字！');
                      }else if($.trim(value)<=0 || $.trim(value)%1 !=0){
                            $.alert('请输入正确的数量！');   
                      }else{
                            $.alert('数量不能为空！');
                      }
                    },
                    function (value) {
                      //$.alert('标签是 "' + value + '". You clicked Cancel button');
                    }
                );
            });
            
        });
        // $(document).on("pageInit", function(e, id, page) {
            
        //     alert($('[data-role="evaluate"]').html());
        //     $(document).delegate('[data-role="evaluate"]','infinite',function(){
        //         debugger;
        //         // 如果正在加载，则退出
        //         if (loading) return;

        //         // 设置flag
        //         loading = true;
                
        //         //新增一页
        //         pageIndex = pageIndex + 1;

        //         getEvaluates(pageIndex, grade);

        //     });
        // });
              
        // $.init();
    </script>
  </body>
</html>